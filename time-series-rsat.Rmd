---
title: "Downloading & Processing Data Cubes: `rsat.pkg`"
output: github_document
---

```{r setup, include=FALSE, warning=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = TRUE, eval = FALSE)
```

### Data Sources

So far, the `rsat` packaged has proved most reliable. Better at accessing, scanning and downloading, though it doesnt include a quick download option and tends to involve longer processing and coding time. In-built vignettes seem to be best learning resources (i.e. `rsat::rsat1_search`).

Access issues, consider that `rsat` communicates with data archives through *APIs* using the following functions. Sort out your earthdata privileges first...

```{r, eval=T, warning=FALSE, error=FALSE}
library(rsat)
#set_credentials("username","password", "earthdata") ## not working ???
library(getSpatialData) ## is working ???
getSpatialData::login_earthdata()
getSpatialData::login_USGS()
services()
```

### Loading Data Libraries

```{r, cache=TRUE, message=FALSE, warning=FALSE}
library(sf)
library(tmap)
# search paramters
ip <- st_sf(st_as_sfc(st_bbox(c(
  xmin = 35.09583,
  xmax = 36.29583,
  ymin = -15.90890,
  ymax = -14.77500 
), crs = 4326)))
toi_2018 <- seq(as.Date("2018-10-01"),as.Date("2021-12-30"),1)

# review available ibrary
rsat_products()
# confirm available collections
browse = rsat_search(
  region = ip,
  dates = toi_2018,
  product = c(
    "landsat_ot_c2_l1", 
    "landsat_etm_c2_l1", 
    "landsat_tm_c2_l1"),
  verbose=F) # NOTE: tm unavailable for toi_2018  

# assign location for downloads 
db.path <- "/media/seamus/Ubuntu 22_04 LTS amd64/rsat/edits/database"
ds.path <- "/media/seamus/Ubuntu 22_04 LTS amd64/rsat/edits/datasets"
dir.create(db.path)
dir.create(ds.path)

# derive 'rtoi' spatial-filter
chilwa1 <- new_rtoi(
  name = "chilwa1",
  region = ip,
  db_path = db.path,
  rtoi_path = ds.path)

# prep downloads using filters: rtoi & toi_2018  
chilwa_2018 = rsat_search(
  region = chilwa1,
  dates = toi_2018,
  product = c(
    "landsat_ot_c2_l1", 
    "landsat_etm_c2_l1") )

# download w/o processing (.../rtoi assigned folder)
rsat_download(chilwa1)

# download w/ mosaic+clip+compression processing
rsat_mosaic(chilwa1)

# check outputs
list.files(
  file.path(
    ds.path, "chilwa1", 
    "/media/seamus/Ubuntu 22_04 LTS amd64/rsat/edits/mosaics"),  
  full.name = T)

plot(filomena, as.Date("2018-11-11"),xsize = 500, ysize = 500) # res increased from default plot which is 250x250-pixels LxW.


```

```{r}



db.path <- file.path(tempdir(),"database")
ds.path <- file.path(tempdir(),"datasets")
dir.create(db.path)
dir.create(ds.path)
The minimum information to generate a new rtoi is a name for the object, a polygon of the region of interest (roi), and the paths to the database and dataset:

filomena <- new_rtoi(name = "filomena",
                     region = ip,
                     db_path = db.path,
                     rtoi_path = ds.path)
To limit the amount of data and processing times, the assessment is conducted over MODIS imagery. A total number of 24
 images are found for the region over the 6
-day period:

rsat_search(region = filomena, product = c("mod09ga"), dates = toi)
The way to download the search results is as follows:

rsat_download(filomena)


roi_gpkg = sf::st_read("~/git_repos/time-series-rsat/roi/chilwa_watershed_4326.gpkg") 
roi_sf_sfc_bbox = st_sf(st_as_sfc(st_bbox(roi_gpkg)))
bbox_raw = st_bbox(roi_gpkg)

toi_2018_dry <- seq(as.Date("2018-10-01"),as.Date("2018-12-30"),1)



rtoi1 = new_rtoi(
  name = "rtoi1",
  region = roi_sf_sfc_bbox,
  db_path = db.path,
  rtoi_path = ds.path)
  
rsat_search(
  region = rtoi1, 
  dates = toi_2018_dry)

rsat_download(rtoi1)

```

You can also embed plots, for example:

```{r pressure, echo=FALSE}
unique(sat_name(rcd))
names(rcd)[1]
unique(dates(rcd))
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
